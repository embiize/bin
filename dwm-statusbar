#!/bin/bash
# Status bar for dwm (see http://jasonwryan.com/)
# colors: \x01 grey; \x02 white; \x04 red; \x05 green; \x06 yellow; 
#         \x07 blue; \x08 magenta; \x09 cyan

print_last_msg() {
  last_msg="$(cat ~/.irssi_pipe)"
  echo -e "\x06Ò ${last_msg}\x01"
}

print_gmail_unread() {
  gmail_unread="$(find ~/.maildir/gmail/inbox/new -type f | wc -l)"
  echo -e "\x06Ó ${gmail_unread}\x01 GM"
}

print_mq_unread() {
  mq_unread="$(find ~/.maildir/mq/inbox/new -type f | wc -l)"
  echo -e "\x06Ó ${mq_unread}\x01 MQ"
}

print_dropbox_status() {
  echo -e "\x07Ù $(dropbox status)\x01"
}

print_mem_used() {
  mem_used="$(free -m | awk '/buffers\/cache/ {print $3}')"
  echo -e "${mem_used}M"
}

print_song_info() {
  song_info="$(ncmpcpp --now-playing '{{{{%a - }%t}}|{%f}}' | head -c 60)"
  if [[ ! $song_info ]]; then
    song_info="Not playing"
  fi
  echo -e "\x08Î ${song_info}\x01"
}

print_volume() {
  volume="$(amixer get Master | tail -n1 | sed -r 's/.*\[(.*)%\].*/\1/')"
  echo -e "\x09Ô ${volume}%\x01"
}

print_datetime() {
  datetime="$(date "+%a %d %b, %I:%M %p")"
  echo -e "\x02Õ ${datetime}\x01"
}



# network (see: http://dzen.geekmode.org/dwiki/doku.php?id=dzen:network-meter)
# cpu (see:https://bbs.archlinux.org/viewtopic.php?pid=661641#p661641)
rx_old=$(cat /sys/class/net/eth0/statistics/rx_bytes)
tx_old=$(cat /sys/class/net/eth0/statistics/tx_bytes)

while true; do
  # get new cpu idle and total usage
  eval $(awk '/^cpu /{print "cpu_idle_now=" $5 \
    "; cpu_total_now=" $2+$3+$4+$5 }' /proc/stat)
  cpu_interval=$((cpu_total_now-${cpu_total_old:-0}))
  # calculate cpu usage (%)
  let cpu_used="100 * ($cpu_interval - ($cpu_idle_now-${cpu_idle_old:-0})) \
    / $cpu_interval"

  # get new rx/tx counts
  rx_now=$(cat /sys/class/net/eth0/statistics/rx_bytes)
  tx_now=$(cat /sys/class/net/eth0/statistics/tx_bytes)
  # calculate the rate (K) and total (M)
  let rx_rate=($rx_now-$rx_old)/1024
  let tx_rate=($tx_now-$tx_old)/1024
  let rx_total=$rx_now/1048576
  let tx_total=$tx_now/1048576

  # output vars
  print_cpu_used() { echo -e "\x07Ï ${cpu_used}%\x01"; }
  print_rx_rate() { echo -e "\x05Ð ${rx_rate}K\x01"; }
  print_rx_total() { echo -e "${rx_total}M"; }
  print_tx_rate() { echo -e "\x04Ñ ${tx_rate}K\x01"; }
  print_tx_total() { echo -e "${tx_total}M"; }

  # Pipe to status bar, not indented due to printing extra spaces/tabs
  xsetroot -name "Ö $(print_last_msg) Ö \
$(print_gmail_unread) $(print_mq_unread) Ö \
$(print_rx_rate) $(print_rx_total) $(print_tx_rate) $(print_tx_total) Ö \
$(print_cpu_used) $(print_mem_used) Ö \
$(print_song_info) Ö \
$(print_volume) Ö \
$(print_datetime) "

  # reset old rates
  rx_old=$rx_now
  tx_old=$tx_now
  cpu_idle_old=$cpu_idle_now
  cpu_total_old=$cpu_total_now
  # loop stats every 1 second
  sleep 1
done
